## 如何调试

### 原理

Flutter 在编译工程时，使用位于 `flutter/bin/cache/dart-sdk/bin/snapshots` 目录下的 frontend_server.dart.snapshot，将项目代码编译成 app.dill 文件

### 调试步骤

#### 1. 进入您的工程目录，清除编译缓存

```dart
cd <您的工程目录>
flutter clean
```

#### 2. 获取 frontend_server.dart.snapshot 执行命令

```dart
flutter run -v --release
```

运行成功后，搜索 frontend_server.dart.snapshot

![如何调试](./get_command.png)

复制并删除 frontend_server.dart.snapshot 路径相关以及 dart 路径相关的命令，得到如下：

```dart
--sdk-root
                    /Users/Mao/flutter/bin/cache/artifacts/engine/common/flutter_patched_sdk_product/ --target=flutter --no-print-incremental-dependencies -DFLUTTER_WEB_AUTO_DETECT=true -Ddart.vm.profile=false
                    -Ddart.vm.product=true --compact-async --aot --tfa --packages /Users/Mao/growingio/growingio-sdk-flutter/example_autotracker/.dart_tool/package_config.json --output-dill
                    /Users/Mao/growingio/growingio-sdk-flutter/example_autotracker/.dart_tool/flutter_build/114f6d51a11516b540fc0dfc5faa0b88/app.dill --depfile
                    /Users/Mao/growingio/growingio-sdk-flutter/example_autotracker/.dart_tool/flutter_build/114f6d51a11516b540fc0dfc5faa0b88/kernel_snapshot.d --source
                    file:///Users/Mao/growingio/growingio-sdk-flutter/example_autotracker/.dart_tool/flutter_build/dart_plugin_registrant.dart --source package:flutter/src/dart_plugin_registrant.dart
                    -Dflutter.dart_plugin_registrant=file:///Users/Mao/growingio/growingio-sdk-flutter/example_autotracker/.dart_tool/flutter_build/dart_plugin_registrant.dart --verbosity=error
                    package:growingio_flutter_example/main.dart
```

#### 3. 下载 dart 源码

```shell
git clone https://github.com/dart-lang/sdk
```

修改 pubspec.yaml 依赖，如下：

```yaml
dependency_overrides:
  package_config: any
  kernel:
    path: /您所下载的 dart 源码目录/sdk/pkg/kernel
  meta:
    path: /您所下载的 dart 源码目录/sdk/pkg/meta
  frontend_server:
    path: /您所下载的 dart 源码目录/sdk/pkg/frontend_server
  front_end:
    path: /您所下载的 dart 源码目录/sdk/pkg/front_end
  dart2js_info:
    path: /您所下载的 dart 源码目录/sdk/pkg/dart2js_info
  dev_compiler:
    path: /您所下载的 dart 源码目录/sdk/pkg/dev_compiler
  _fe_analyzer_shared:
    path: /您所下载的 dart 源码目录/sdk/pkg/_fe_analyzer_shared
  js_shared:
    path: /您所下载的 dart 源码目录/sdk/pkg/js_shared
  build_integration:
    path: /您所下载的 dart 源码目录/sdk/pkg/build_integration
  _js_interop_checks:
    path: /您所下载的 dart 源码目录/sdk/pkg/_js_interop_checks
  compiler:
    path: /您所下载的 dart 源码目录/sdk/pkg/compiler
  js_runtime:
    path: /您所下载的 dart 源码目录/sdk/pkg/js_runtime
  js_ast:
    path: /您所下载的 dart 源码目录/sdk/pkg/js_ast
  vm:
    path: /您所下载的 dart 源码目录/sdk/pkg/vm
```

#### 4. 源码调试 growingio-dart-frontend

将本项目拖入 Android Studio，添加 Dart Command Line App

![添加命令](./dart_command_line_app.png)

**Dart file** 选择 `growingio-dart-frontend/lib/flutter_frontend_server/frontend_server_starter.dart`

**Program arguments** 填入步骤 2 获取到的命令，无需调整格式，填入后会自动格式化

**Working directory** 选择您的工程

之后就可以在 Debug 下打断点调试 growingio-dart-frontend 的代码了